<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RJF Blood Connect - Roktojoba Foundation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <!-- Favicon Links -->
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="icon" href="favicon.png" sizes="16x16" type="image/png">
    <link rel="icon" href="favicon.png" sizes="32x32" type="image/png">
    <link rel="apple-touch-icon" href="favicon.png">
</head>

<body>
    <!-- Header with Logo and Time -->
    <header class="header">
        <!-- Time and Date above the header content -->
        <div class="container-fluid py-1 bg-light">
            <div class="row">
                <div class="col-6 text-start">
                    <!-- Empty left side -->
                </div>
                <div class="col-6 text-end">
                    <div id="currentDate" class="bangla-text date-display"></div>
                    <div id="currentTime" class="bangla-text time-display"></div>
                </div>
            </div>
        </div>

        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-2">
                    <img src="roktojoba-logo.png" alt="Roktojoba Foundation Logo" class="logo">
                </div>
                <div class="col-8 text-center">
                    <h1>RJF Blood Connect</h1>
                    <p class="tagline">Blood Donate. Connect. Save</p>
                </div>
                <div class="col-2 text-end">
                    <!-- You can keep this empty or add something else -->
                </div>
            </div>
        </div>
    </header>

    <!-- Updated Stats Section -->
    <div class="stats-section py-4">
        <div class="container">
            <div class="row g-4">
                <!-- Registered Donors -->
                <div class="col-md-3 col-6">
                    <div class="stat-card bg-white rounded-3 p-3 shadow-sm text-center h-100">
                        <div class="stat-icon mb-2">
                            <i class="fas fa-users fa-2x text-primary"></i>
                        </div>
                        <div class="stat-number fw-bold fs-3" id="donors-count">0</div>
                        <div class="stat-label bangla-text text-muted">নিবন্ধিত রক্তদাতা</div>
                    </div>
                </div>

                <!-- Blood Requests -->
                <div class="col-md-3 col-6">
                    <div class="stat-card bg-white rounded-3 p-3 shadow-sm text-center h-100">
                        <div class="stat-icon mb-2">
                            <i class="fas fa-hand-holding-medical fa-2x text-danger"></i>
                        </div>
                        <div class="stat-number fw-bold fs-3" id="requests-count">0</div>
                        <div class="stat-label bangla-text text-muted">রক্তের অনুরোধ</div>
                    </div>
                </div>

                <!-- Successful Donations -->
                <div class="col-md-3 col-6">
                    <div class="stat-card bg-white rounded-3 p-3 shadow-sm text-center h-100">
                        <div class="stat-icon mb-2">
                            <i class="fas fa-heartbeat fa-2x text-success"></i>
                        </div>
                        <div class="stat-number fw-bold fs-3" id="lives-saved">0</div>
                        <div class="stat-label bangla-text text-muted">সফল রক্তদান</div>
                    </div>
                </div>

                <!-- District Coverage -->
                <div class="col-md-3 col-6">
                    <div class="stat-card bg-white rounded-3 p-3 shadow-sm text-center h-100">
                        <div class="stat-icon mb-2">
                            <i class="fas fa-map-marked-alt fa-2x text-info"></i>
                        </div>
                        <div class="stat-number fw-bold fs-3" id="districts-covered">0</div>
                        <div class="stat-label bangla-text text-muted">জেলা কভারেজ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container py-3">
        <!-- Features Section -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="row g-2">
                    <!-- Donor Registration Card -->
                    <div class="col-md-3 col-6">
                        <a href="donor-registration.html" class="feature-card">
                            <div class="card h-100 text-center">
                                <div class="card-body d-flex flex-column">
                                    <div class="mb-2">
                                        <i class="fas fa-user-plus feature-icon"></i>
                                        <h6 class="card-title mb-0">রক্তদাতা নিবন্ধন</h6>
                                    </div>
                                    <span class="btn btn-sm btn-primary mt-auto">
                                        <i class="fas fa-arrow-right"></i> নিবন্ধন করুন
                                    </span>
                                </div>
                            </div>
                        </a>
                    </div>

                    <!-- Blood Request Card -->
                    <div class="col-md-3 col-6">
                        <a href="blood-request.html" class="feature-card">
                            <div class="card h-100 text-center">
                                <div class="card-body d-flex flex-column">
                                    <div class="mb-2">
                                        <i class="fas fa-tint feature-icon"></i>
                                        <h6 class="card-title mb-0">রক্তের অনুরোধ</h6>
                                    </div>
                                    <span class="btn btn-sm btn-primary mt-auto">
                                        <i class="fas fa-arrow-right"></i> অনুরোধ করুন
                                    </span>
                                </div>
                            </div>
                        </a>
                    </div>

                    <!-- Find Donor Card -->
                    <div class="col-md-3 col-6">
                        <a href="donor-search.html" class="feature-card">
                            <div class="card h-100 text-center">
                                <div class="card-body d-flex flex-column">
                                    <div class="mb-2">
                                        <i class="fas fa-search feature-icon"></i>
                                        <h6 class="card-title mb-0">রক্তদাতা খুঁজুন</h6>
                                    </div>
                                    <span class="btn btn-sm btn-primary mt-auto">
                                        <i class="fas fa-arrow-right"></i> খুঁজুন
                                    </span>
                                </div>
                            </div>
                        </a>
                    </div>

                    <!-- Update Donation Date Card -->
                    <div class="col-md-3 col-6">
                        <div class="card h-100 text-center">
                            <div class="card-body d-flex flex-column">
                                <div class="mb-2">
                                    <i class="fas fa-calendar-alt feature-icon"></i>
                                    <h6 class="card-title mb-0">রক্তদানের তারিখ</h6>
                                </div>
                                <button class="btn btn-sm btn-primary mt-auto" data-bs-toggle="modal"
                                    data-bs-target="#updateDonationModal">
                                    <i class="fas fa-edit"></i> আপডেট করুন
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Blood Requests Section - Improved -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="section-title"><i class="fas fa-hand-holding-medical feature-icon"></i> সাম্প্রতিক রক্তের
                    অনুরোধ</h2>
                <div class="loading-spinner" id="requestsLoading">
                    <div class="spinner-border spinner" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="bangla-text">অনুরোধের তথ্য লোড করা হচ্ছে...</p>
                </div>
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="requestsList">
                    <!-- Request cards will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Successful Donations Section - Enhanced -->
        <div class="row mt-5">
            <div class="col-12">
                <h2 class="section-title"><i class="fas fa-heartbeat feature-icon"></i> সফল রক্তদানের গল্প</h2>
                <div class="loading-spinner" id="successStoriesLoading">
                    <div class="spinner-border spinner" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="bangla-text">সফল রক্তদানের তথ্য লোড করা হচ্ছে...</p>
                </div>
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="successStoriesList">
                    <!-- Success story cards will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Add this button below the Emergency Section -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#voteDonationModal">
                    <i class="fas fa-check-circle me-2"></i> সফল রক্তদান রিপোর্ট করুন
                </button>
            </div>
        </div>
    </div>

    <!-- Update Donation Date Modal -->
    <div class="modal fade" id="updateDonationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">রক্তদানের তারিখ আপডেট করুন</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="updateDonationForm">
                        <div class="mb-3">
                            <label for="donorPhoneUpdate" class="form-label">মোবাইল নম্বর</label>
                            <input type="tel" class="form-control" id="donorPhoneUpdate" required
                                pattern="^(01[3-9]\d{8})$">
                            <div class="invalid-feedback">সঠিক মোবাইল নম্বর লিখুন (01XXXXXXXXX)</div>
                        </div>
                        <div class="mb-3">
                            <label for="lastDonationUpdate" class="form-label">সর্বশেষ রক্তদানের তারিখ</label>
                            <input type="date" class="form-control" id="lastDonationUpdate" required>
                            <div class="invalid-feedback">তারিখ নির্বাচন করুন</div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">আপডেট করুন</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Vote Donation Modal -->
    <div class="modal fade" id="voteDonationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">সফল রক্তদান রিপোর্ট করুন</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="voteDonationForm">
                        <div class="mb-3">
                            <label for="requestPhone" class="form-label">অনুরোধকারীর মোবাইল নম্বর</label>
                            <input type="tel" class="form-control" id="requestPhone" required
                                pattern="^(01[3-9]\d{8})$">
                            <div class="invalid-feedback">সঠিক মোবাইল নম্বর লিখুন (01XXXXXXXXX)</div>
                        </div>
                        <div class="mb-3">
                            <label for="donorPhone" class="form-label">রক্তদাতার মোবাইল নম্বর</label>
                            <input type="tel" class="form-control" id="donorPhone" required pattern="^(01[3-9]\d{8})$">
                            <div class="invalid-feedback">সঠিক মোবাইল নম্বর লিখুন (01XXXXXXXXX)</div>
                        </div>
                        <div class="mb-3">
                            <label for="donationDate" class="form-label">রক্তদানের তারিখ</label>
                            <input type="date" class="form-control" id="donationDate" required>
                            <div class="invalid-feedback">তারিখ নির্বাচন করুন</div>
                        </div>
                        <button type="submit" class="btn btn-success w-100">জমা দিন</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Bar -->
    <div class="navigation">
        <div class="icons">
            <input type="radio" name="nav" id="nav-home" class="nav-radio" />
            <label for="nav-home" class="nav-icon" onclick="window.location.href='index.html'">
                <i class="fas fa-home"></i>
                <span class="nav-text bangla-text">হোম</span>
            </label>

            <input type="radio" name="nav" id="nav-register" class="nav-radio" />
            <label for="nav-register" class="nav-icon" onclick="window.location.href='donor-registration.html'">
                <i class="fas fa-user-plus"></i>
                <span class="nav-text bangla-text">নিবন্ধন</span>
            </label>

            <input type="radio" name="nav" id="nav-request" class="nav-radio" />
            <label for="nav-request" class="nav-icon" onclick="window.location.href='blood-request.html'">
                <i class="fas fa-tint"></i>
                <span class="nav-text bangla-text">অনুরোধ</span>
            </label>

            <input type="radio" name="nav" id="nav-search" class="nav-radio" />
            <label for="nav-search" class="nav-icon" onclick="window.location.href='donor-search.html'">
                <i class="fas fa-search"></i>
                <span class="nav-text bangla-text">খুঁজুন</span>
            </label>

            <input type="radio" name="nav" id="nav-info" class="nav-radio" />
            <label for="nav-info" class="nav-icon" onclick="window.location.href='information.html'">
                <i class="fas fa-info-circle"></i>
                <span class="nav-text bangla-text">তথ্য</span>
            </label>
        </div>
    </div>

    <!-- Emergency WhatsApp Button -->
    <a href="emergency-contact.html" class="emergency-btn">
        <i class="fas fa-phone-alt"></i>
    </a>

    <!-- Developer Credit -->
    <div class="text-center mt-4 small text-muted">
        Developed by MD Tasrik Hossain
    </div>

    <!-- Firebase and other scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
        import {
            getFirestore,
            collection,
            getDocs,
            query,
            orderBy,
            limit,
            updateDoc,
            doc,
            where,
            writeBatch,
            addDoc
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBSgyeYCbyB8cMFdqMcNtDZeL4aM-_FfQ4",
            authDomain: "rjf-blood-connect.firebaseapp.com",
            databaseURL: "https://rjf-blood-connect-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "rjf-blood-connect",
            storageBucket: "rjf-blood-connect.firebasestorage.app",
            messagingSenderId: "536870508483",
            appId: "1:536870508483:web:1ce2211ec28f79ce514f76",
            measurementId: "G-34RDD8GL9C"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // Format phone number function
        function formatPhoneNumber(phone) {
            let cleaned = phone.replace(/\D/g, '');

            if (cleaned.startsWith('88')) {
                cleaned = cleaned.substring(2);
            } else if (cleaned.startsWith('+88')) {
                cleaned = cleaned.substring(3);
            }

            if (cleaned.length === 10 && cleaned.startsWith('1')) {
                cleaned = '0' + cleaned;
            }

            return cleaned;
        }

        // Helper function to show alerts
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-fixed`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

            document.body.appendChild(alertDiv);

            // Auto remove after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Update the displayRecentBloodRequests function
        async function displayRecentBloodRequests() {
            const loading = document.getElementById('requestsLoading');
            const requestsList = document.getElementById('requestsList');

            try {
                loading.style.display = 'block';
                requestsList.innerHTML = '';

                const q = query(
                    collection(db, "requests"),
                    where("status", "in", ["pending", "processing"]),
                    orderBy("createdAt", "desc"),
                    limit(6)
                );

                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    requestsList.innerHTML = `
                <div class="col-12 text-center py-4">
                    <div class="alert alert-info">কোনো সাম্প্রতিক রক্তের অনুরোধ পাওয়া যায়নি</div>
                </div>
            `;
                    return;
                }

                querySnapshot.forEach((doc) => {
                    try {
                        const request = doc.data();
                        if (!request) throw new Error("Invalid request data");

                        request.id = doc.id;
                        requestsList.appendChild(createRequestCard(request));
                    } catch (error) {
                        console.error("Error processing request document:", error);
                    }
                });

            } catch (error) {
                console.error("Error loading blood requests: ", error);

                // More detailed error message
                let errorMessage = "ত্রুটি ঘটেছে, পরে আবার চেষ্টা করুন";
                if (error.code === "permission-denied") {
                    errorMessage = "ডাটা অ্যাক্সেসের অনুমতি নেই। অ্যাডমিনের সাথে যোগাযোগ করুন।";
                } else if (error.code === "unavailable") {
                    errorMessage = "নেটওয়ার্ক সমস্যা হচ্ছে। ইন্টারনেট সংযোগ পরীক্ষা করুন।";
                }

                requestsList.innerHTML = `
            <div class="col-12 text-center py-4">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${errorMessage}
                    <div class="mt-2 small">ত্রুটির বিস্তারিত: ${error.message || 'Unknown error'}</div>
                </div>
            </div>
        `;
            } finally {
                loading.style.display = 'none';
            }
        }

        // Function to create request cards
        function createRequestCard(request) {
            const col = document.createElement('div');
            col.className = 'col';

            const card = document.createElement('div');
            card.className = 'card request-card h-100 border-start border-4 border-danger';

            // Format dates and times
            const neededDate = request.neededDate ?
                new Date(request.neededDate).toLocaleDateString('bn-BD', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                }) : 'জরুরি';

            const neededTime = request.neededTime || 'যত তাড়াতাড়ি সম্ভব';

            const createdAt = request.createdAt?.toDate?.() ?
                request.createdAt.toDate().toLocaleString('bn-BD', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'N/A';

            card.innerHTML = `
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="badge bg-danger rounded-pill">রক্তের গ্রুপ: ${request.bloodGroup}</span>
                <span class="badge bg-secondary rounded-pill">রক্তের পরিমাণ: ${request.bloodAmount} ব্যাগ</span>
            </div>
            <div class="mb-3">
                <p class="card-text mb-1"><i class="fas fa-hospital me-2 text-muted"></i> <strong>${request.location || 'N/A'}</strong></p>
                <p class="card-text mb-1"><i class="fas fa-map-marker-alt me-2 text-muted"></i> জেলা: ${request.district || 'N/A'}, উপজেলা: ${request.upazila || 'N/A'}</p>
                <p class="card-text mb-1"><i class="fas fa-calendar-day me-2 text-muted"></i> তারিখ: <strong>${neededDate}</strong></p>
                <p class="card-text mb-1"><i class="fas fa-clock me-2 text-muted"></i> সময়: <strong>${neededTime}</strong></p>
                <p class="card-text mb-1"><i class="fas fa-user-clock me-2 text-muted"></i> অনুরোধের সময়: ${createdAt}</p>
                <p class="card-text mb-1"><i class="fas fa-phone me-2 text-muted"></i> ${request.phone || 'N/A'}</p>
            </div>
            <div class="mt-auto">
                <span class="badge bg-${request.status === 'pending' ? 'warning' : 'info'} text-dark">
                    ${request.status === 'pending' ? 'অপেক্ষমান' : 'প্রক্রিয়াধীন'}
                </span>
            </div>
        </div>
        <div class="card-footer bg-white d-flex gap-2 border-top-0">
            <a href="tel:${request.phone || ''}" class="btn btn-danger flex-grow-1 contact-btn">
                <i class="fas fa-phone me-2"></i> কল করুন
            </a>
            <a href="https://wa.me/88${request.phone || ''}" class="btn btn-success whatsapp-btn">
                <i class="fab fa-whatsapp"></i>
            </a>
        </div>
    `;

            col.appendChild(card);
            return col;
        }

        // Function to display recent successful donations
        async function displayRecentSuccessfulDonations() {
            const loading = document.getElementById('successStoriesLoading');
            const successStoriesList = document.getElementById('successStoriesList');

            try {
                loading.style.display = 'block';
                successStoriesList.innerHTML = '';

                const q = query(
                    collection(db, "successfulDonations"),
                    orderBy("donationDate", "desc"),
                    limit(3)
                );

                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    successStoriesList.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <div class="alert alert-info">কোনো সফল রক্তদানের তথ্য পাওয়া যায়নি</div>
                    </div>
                `;
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const donation = doc.data();
                    donation.id = doc.id;
                    successStoriesList.appendChild(createSuccessStoryCard(donation));
                });

            } catch (error) {
                console.error("Error loading success stories: ", error);
                successStoriesList.innerHTML = `
                <div class="col-12 text-center py-4">
                    <div class="alert alert-danger">ত্রুটি ঘটেছে, পরে আবার চেষ্টা করুন</div>
                </div>
            `;
            } finally {
                loading.style.display = 'none';
            }
        }

        // Function to create success story cards
        function createSuccessStoryCard(donation) {
            const col = document.createElement('div');
            col.className = 'col';

            const card = document.createElement('div');
            card.className = 'card success-card h-100 border-0 shadow-sm';

            // Format dates
            const donationDate = donation.donationDate?.toDate?.() || new Date();
            const formattedDate = donationDate.toLocaleDateString('bn-BD');

            // Safely access nested properties
            const requestDetails = donation.requestDetails || {};
            const donorDetails = donation.donorDetails || {};

            card.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="success-badge">
                        <i class="fas fa-heart me-2"></i> সফল রক্তদান
                    </div>
                    <span class="badge bg-danger rounded-pill">${requestDetails.bloodGroup || 'N/A'}</span>
                </div>
                
                <div class="mb-3">                    
                    <p class="card-text mb-2">
                        <i class="fas fa-hospital me-2 text-danger"></i> 
                        <strong>হাসপাতাল:</strong> ${requestDetails.hospital || 'N/A'}
                    </p>
                    <p class="card-text mb-2">
                        <i class="fas fa-map-marker-alt me-2 text-danger"></i> 
                        <strong>স্থান:</strong> ${requestDetails.division || 'N/A'}, ${requestDetails.district || 'N/A'}, ${requestDetails.upazila || 'N/A'}
                    </p>
                    <p class="card-text mb-2">
                        <i class="fas fa-calendar-alt me-2 text-danger"></i> 
                        <strong>তারিখ:</strong> ${formattedDate}
                    </p>
                </div>
                
                <div class="donor-info mt-3 p-3 bg-light rounded">
                    <h6 class="text-success"><i class="fas fa-user-check me-2"></i> রক্তদাতার তথ্য:</h6>
                    <p class="mb-1"><strong>নাম:</strong> ${donorDetails.name || 'N/A'}</p>
                    <p class="mb-1"><strong>মোবাইল:</strong> ${donorDetails.phone || 'N/A'}</p>
                    <p class="mb-1"><strong>স্থান:</strong> ${donorDetails.division || 'N/A'}, ${donorDetails.district || 'N/A'}, ${donorDetails.upazila || 'N/A'}</p>
                    <p class="mb-1"><strong>ব্লাড গ্রুপ:</strong> ${donorDetails.bloodGroup || 'N/A'}</p>
                </div>
                
                <div class="testimonial mt-3" style="display: ${donation.testimonial ? 'block' : 'none'}">
                    <i class="fas fa-quote-left"></i>
                    <p class="mb-0">${donation.testimonial || ''}</p>
                </div>
            </div>
        `;

            col.appendChild(card);
            return col;
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('bn-BD');
        }

        async function updateStats() {
            try {
                console.log("Updating stats...");

                // Get total registered donors count
                const donorsQuery = query(collection(db, "donors"));
                const donorsSnapshot = await getDocs(donorsQuery);
                document.getElementById('donors-count').textContent = donorsSnapshot.size + '+';
                console.log("Total donors:", donorsSnapshot.size);

                // Get total blood requests count
                const requestsQuery = query(collection(db, "requests"));
                const requestsSnapshot = await getDocs(requestsQuery);
                document.getElementById('requests-count').textContent = requestsSnapshot.size + '+';
                console.log("Total requests:", requestsSnapshot.size);

                // Get successful donations count (completed requests)
                const donationsQuery = query(collection(db, "requests"), where("status", "==", "completed"));
                const donationsSnapshot = await getDocs(donationsQuery);
                document.getElementById('lives-saved').textContent = donationsSnapshot.size + '+';
                console.log("Successful donations:", donationsSnapshot.size);

                // Get unique districts covered by donors
                const districtsQuery = query(collection(db, "donors"));
                const districtsSnapshot = await getDocs(districtsQuery);

                const uniqueDistricts = new Set();
                districtsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.district) {
                        uniqueDistricts.add(data.district);
                    }
                });

                document.getElementById('districts-covered').textContent = uniqueDistricts.size;
                console.log("Districts covered:", uniqueDistricts.size);

            } catch (error) {
                console.error("Error updating stats: ", error);
                // Fallback to default values if there's an error
                document.getElementById('donors-count').textContent = '3580+';
                document.getElementById('requests-count').textContent = '1425+';
                document.getElementById('lives-saved').textContent = '1128+';
                document.getElementById('districts-covered').textContent = '64';
            }
        }

        // Load recent donors and initialize the page
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                // Update stats immediately
                await updateStats();
                // Load recent requests
                await displayRecentBloodRequests();
                // Load success stories
                await displayRecentSuccessfulDonations();
            } catch (error) {
                console.error("Error initializing page: ", error);
            }

            // Handle donation date update
            document.getElementById('updateDonationForm').addEventListener('submit', async function (e) {
                e.preventDefault();
                if (this.checkValidity()) {
                    try {
                        const phone = document.getElementById('donorPhoneUpdate').value;
                        const lastDonation = document.getElementById('lastDonationUpdate').value;

                        // Format phone number consistently
                        const formattedPhone = formatPhoneNumber(phone);

                        // Find donor by phone
                        const q = query(collection(db, "donors"), where("phone", "==", formattedPhone));
                        const querySnapshot = await getDocs(q);

                        if (querySnapshot.empty) {
                            showAlert("এই মোবাইল নম্বরের সাথে কোনো রক্তদাতা পাওয়া যায়নি", "danger");
                            return;
                        }

                        // Update all matching donors
                        const batch = writeBatch(db);
                        querySnapshot.forEach((doc) => {
                            const docRef = doc.ref;
                            batch.update(docRef, {
                                lastDonation: new Date(lastDonation),
                                updatedAt: new Date()
                            });
                        });

                        await batch.commit();

                        showAlert("রক্তদানের তারিখ সফলভাবে আপডেট করা হয়েছে!", "success");
                        this.reset();
                        this.classList.remove('was-validated');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('updateDonationModal'));
                        modal.hide();

                    } catch (error) {
                        console.error("Error updating donation date: ", error);
                        showAlert("ত্রুটি ঘটেছে, পরে আবার চেষ্টা করুন", "danger");
                    }
                } else {
                    this.classList.add('was-validated');
                }
            });

            // Handle successful donation form submission
            document.getElementById('voteDonationForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                if (this.checkValidity()) {
                    try {
                        const requestPhone = formatPhoneNumber(document.getElementById('requestPhone').value);
                        const donorPhone = formatPhoneNumber(document.getElementById('donorPhone').value);
                        const donationDate = document.getElementById('donationDate').value;

                        // Validate request phone exists in requests
                        const requestQuery = query(collection(db, "requests"),
                            where("phone", "==", requestPhone),
                            where("status", "in", ["pending", "processing"]));
                        const requestSnapshot = await getDocs(requestQuery);

                        if (requestSnapshot.empty) {
                            showAlert("এই মোবাইল নম্বরের সাথে কোনো সক্রিয় রক্তের অনুরোধ পাওয়া যায়নি", "warning");
                            return;
                        }

                        // Get the most recent request if multiple exist
                        let latestRequest = null;
                        requestSnapshot.forEach(doc => {
                            const request = doc.data();
                            if (!latestRequest || request.createdAt > latestRequest.createdAt) {
                                latestRequest = { id: doc.id, ...request };
                            }
                        });

                        // Validate donor exists
                        const donorQuery = query(collection(db, "donors"),
                            where("phone", "==", donorPhone));
                        const donorSnapshot = await getDocs(donorQuery);

                        if (donorSnapshot.empty) {
                            showAlert("এই মোবাইল নম্বরের সাথে কোনো নিবন্ধিত রক্তদাতা পাওয়া যায়নি", "warning");
                            return;
                        }

                        // Prepare request details with fallback for undefined values
                        const requestDetails = {
                            bloodGroup: latestRequest.bloodGroup || 'N/A',
                            district: latestRequest.district || 'N/A',
                            division: latestRequest.division || 'N/A',
                            upazila: latestRequest.upazila || 'N/A',
                            hospital: latestRequest.location || 'N/A', // এখানে location ব্যবহার করা হয়েছে
                            patientName: latestRequest.patientName || 'N/A'
                        };

                        // Prepare donor details with fallback for undefined values
                        const donorData = donorSnapshot.docs[0].data();
                        const donorDetails = {
                            name: donorData.name || 'N/A',
                            phone: donorData.phone || 'N/A',
                            bloodGroup: donorData.bloodGroup || 'N/A',
                            district: donorData.district || 'N/A',
                            upazila: donorData.upazila || 'N/A',
                            division: donorData.division || 'N/A'
                        };

                        // Create successful donation record
                        const successRef = collection(db, "successfulDonations");
                        await addDoc(successRef, {
                            requestId: latestRequest.id,
                            requestPhone,
                            donorPhone,
                            donationDate: new Date(donationDate),
                            reportedAt: new Date(),
                            requestDetails: requestDetails,
                            donorDetails: donorDetails
                        });

                        // Update donor's last donation date
                        const batch = writeBatch(db);
                        donorSnapshot.forEach((doc) => {
                            const docRef = doc.ref;
                            batch.update(docRef, {
                                lastDonation: new Date(donationDate),
                                updatedAt: new Date()
                            });
                        });

                        // Update request status to completed
                        const requestRef = doc(db, "requests", latestRequest.id);
                        batch.update(requestRef, {
                            status: "completed",
                            completedAt: new Date(),
                            donorPhone: donorPhone
                        });

                        await batch.commit();

                        showAlert("সফল রক্তদান রিপোর্ট সফলভাবে জমা দেওয়া হয়েছে!", "success");

                        // Reset form and close modal
                        this.reset();
                        this.classList.remove('was-validated');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('voteDonationModal'));
                        modal.hide();

                        // Refresh stats and lists
                        await updateStats();
                        await displayRecentSuccessfulDonations();
                        await displayRecentBloodRequests();

                    } catch (error) {
                        console.error("Error reporting successful donation:", error);
                        showAlert("ত্রুটি ঘটেছে: " + error.message, "danger");
                    }
                } else {
                    this.classList.add('was-validated');
                }
            });
        });

        // Function to update time and date separately
        function updateDateTime() {
            const now = new Date();

            // Time options
            const timeOptions = {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };

            // Date options
            const dateOptions = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };

            document.getElementById('currentTime').textContent = now.toLocaleTimeString('bn-BD', timeOptions);
            document.getElementById('currentDate').textContent = now.toLocaleDateString('bn-BD', dateOptions);
        }

        // Update every second
        setInterval(updateDateTime, 1000);

        // Initial call
        updateDateTime();

        // Highlight current page in navigation
        document.addEventListener('DOMContentLoaded', function () {
            const currentPage = window.location.pathname.split('/').pop() || 'index.html';
            const navItems = {
                'index.html': 'nav-home',
                'donor-registration.html': 'nav-register',
                'blood-request.html': 'nav-request',
                'donor-search.html': 'nav-search',
                'information.html': 'nav-info'
            };

            if (navItems[currentPage]) {
                document.getElementById(navItems[currentPage]).checked = true;
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="script.js"></script>
</body>

</html>

